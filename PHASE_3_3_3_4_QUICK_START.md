# Phase 3.3 & 3.4 å¿«é€Ÿä¸Šæ‰‹æŒ‡å—

## ğŸ¯ åŠŸèƒ½æ€»è§ˆ

### Phase 3.3: å˜æ›´å†å²ä¸æ’¤é”€
ç”¨æˆ·å¯ä»¥æŸ¥çœ‹ä¹ æƒ¯çš„æ‰€æœ‰ä¿®æ”¹å†å²ï¼Œå¹¶åœ¨30å¤©å†…æ’¤é”€ä»»ä½•ä¸€ä¸ªä¿®æ”¹ã€‚

**æ ¸å¿ƒåœºæ™¯**:
- "å“¦ä¸ï¼Œæˆ‘ä¸å°å¿ƒæ”¹é”™äº†ä¹ æƒ¯åç§°ï¼" â†’ æ‰“å¼€å†å²ï¼Œä¸€é”®æ¢å¤
- "æˆ‘æƒ³çœ‹çœ‹æˆ‘æœ€è¿‘éƒ½æ”¹äº†ä»€ä¹ˆ" â†’ æŸ¥çœ‹å˜æ›´æ—¶é—´çº¿

### Phase 3.4: æ•°æ®å¤‡ä»½ä¸æ¢å¤
ç”¨æˆ·å¯ä»¥è½¯åˆ é™¤ä¹ æƒ¯ï¼ˆ30å¤©å†…å¯æ¢å¤ï¼‰ï¼Œä¹Ÿå¯ä»¥å¯¼å‡ºæ‰€æœ‰æ•°æ®ã€‚

**æ ¸å¿ƒåœºæ™¯**:
- "æˆ‘æƒ³åˆ é™¤è¿™ä¸ªä¹ æƒ¯ï¼Œä½†å¯èƒ½ä¼šæ”¹ä¸»æ„" â†’ è½¯åˆ é™¤ï¼Œ30å¤©å†…å¯æ¢å¤
- "æˆ‘è¦æ¢æ‰‹æœºäº†ï¼Œæƒ³è¦å¤‡ä»½æ•°æ®" â†’ å¯¼å‡ºä¸ºJSONæˆ–CSV

---

## ğŸ“± ç”¨æˆ·æ“ä½œæµç¨‹

### æµç¨‹1: æŸ¥çœ‹å’Œæ’¤é”€å˜æ›´

```
ä¹ æƒ¯è¯¦æƒ…é¡µ
    â†“
ç‚¹å‡» [ğŸ“‹ æŸ¥çœ‹å†å²] æŒ‰é’®
    â†“
è¿›å…¥å˜æ›´å†å²æ—¶é—´çº¿
    â†“
çœ‹åˆ°ä¿®æ”¹å†å²ï¼ˆæœ€æ–°åœ¨ä¸Šï¼‰
    â†“
ç‚¹å‡»æŸæ¡å†å²å±•å¼€è¯¦æƒ…
    â†“
çœ‹åˆ°ä¿®æ”¹å‰åçš„å€¼
    â†“
ç‚¹å‡» [æ¢å¤åˆ°æ­¤çŠ¶æ€] ç¡®è®¤
    â†“
ä¹ æƒ¯æ¢å¤åˆ°é‚£ä¸ªæ—¶é—´ç‚¹
```

**ç¤ºä¾‹**:
- ç”¨æˆ·åœ¨1æœˆ15æ—¥æ”¹äº†ä¹ æƒ¯å"è·‘æ­¥" â†’ "å¿«èµ°"
- åœ¨å†å²ä¸­çœ‹åˆ°è¿™æ¡è®°å½•
- ç‚¹å‡»"æ¢å¤"ï¼Œä¹ æƒ¯åå˜å›"è·‘æ­¥"
- åŒæ—¶ç”Ÿæˆä¸€æ¡æ–°çš„change_log: "æ’¤é”€ä¿®æ”¹"

### æµç¨‹2: è½¯åˆ é™¤ä¸æ¢å¤

```
ä¹ æƒ¯è¯¦æƒ…é¡µ
    â†“
ç‚¹å‡» [ğŸ—‘ï¸ åˆ é™¤] æŒ‰é’®
    â†“
å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡† "åˆ é™¤åå¯åœ¨å·²åˆ é™¤é¡µé¢30å¤©å†…æ¢å¤"
    â†“
ç”¨æˆ·ç‚¹å‡»ç¡®è®¤
    â†“
ä¹ æƒ¯ä»åˆ—è¡¨æ¶ˆå¤±ï¼ˆstatus='deleted'ï¼‰
    â†“
ç”¨æˆ·è¿›å…¥ Settings â†’ [ğŸ—‘ï¸ å·²åˆ é™¤çš„ä¹ æƒ¯]
    â†“
çœ‹åˆ°å·²åˆ é™¤çš„ä¹ æƒ¯ + æ¢å¤å€’è®¡æ—¶ï¼ˆç»¿è‰²è¿›åº¦æ¡ï¼‰
    â†“
ç”¨æˆ·ç‚¹å‡» [æ¢å¤] æˆ– [æ°¸ä¹…åˆ é™¤]
```

**ç‰¹æ®Šæƒ…å†µ**:
- æ¢å¤å€’è®¡æ—¶ â‰¤ 0å¤© â†’ "æ¢å¤æœŸå·²è¿‡æœŸ"ï¼Œ[æ¢å¤]æŒ‰é’®ç¦ç”¨ï¼Œåªèƒ½[æ°¸ä¹…åˆ é™¤]
- ç”¨æˆ·ç‚¹å‡»[æ°¸ä¹…åˆ é™¤] â†’ ç›´æ¥åˆ é™¤ï¼Œæ— æ³•æ¢å¤

### æµç¨‹3: æ•°æ®å¯¼å‡º

```
Settings é¡µé¢
    â†“
ç‚¹å‡» [ğŸ“Š å¯¼å‡ºæ•°æ®]
    â†“
çœ‹åˆ°å¯¼å‡ºè¯´æ˜ + [ç”Ÿæˆå¯¼å‡ºæ•°æ®] æŒ‰é’®
    â†“
ç‚¹å‡»ç”Ÿæˆ
    â†“
åŠ è½½ä¸­... ç”Ÿæˆå®Œæˆåæ˜¾ç¤ºï¼š
  - ä¹ æƒ¯æ€»æ•°: 8
  - å¯¼å‡ºæ—¶é—´: 2024-01-15 10:30:00
    â†“
ç”¨æˆ·é€‰æ‹©æ ¼å¼: JSON / CSV (å•é€‰)
    â†“
çœ‹åˆ°æ•°æ®é¢„è§ˆ (å‰500å­—ç¬¦)
    â†“
ç‚¹å‡» [å¤åˆ¶æ•°æ®] æˆ– [ä¸‹è½½] æŒ‰é’®
    â†“
æ•°æ®å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œç”¨æˆ·æ‰‹åŠ¨ä¿å­˜ä¸ºæ–‡ä»¶
```

**å¯¼å‡ºå†…å®¹**:
- JSON: åŒ…å«æ‰€æœ‰ä¹ æƒ¯ã€ç»Ÿè®¡æ•°æ®ã€å¯¼å‡ºæ—¶é—´
- CSV: è¡¨æ ¼å½¢å¼ï¼Œé€‚åˆExcelæ‰“å¼€

---

## ğŸ› ï¸ å¼€å‘è€…é›†æˆæŒ‡å—

### å¿«é€Ÿæ£€æŸ¥æ¸…å•

```javascript
// 1. éªŒè¯æ•°æ®åº“é›†åˆå­˜åœ¨
âœ“ user_habits æœ‰ status, deleted_at, recover_deadline å­—æ®µ
âœ“ æ–°å»º habit_change_logs é›†åˆ

// 2. éªŒè¯äº‘å‡½æ•°å·²éƒ¨ç½²
âœ“ recordHabitChange
âœ“ getChangeHistory
âœ“ undoHabitChange
âœ“ softDeleteHabit
âœ“ restoreDeletedHabit
âœ“ exportUserData
âœ“ getMyHabits (å·²æ›´æ–°æ”¯æŒstatuså‚æ•°)

// 3. éªŒè¯é¡µé¢å·²åˆ›å»º
âœ“ pages/habit-history/
âœ“ pages/deleted-habits/
âœ“ pages/data-export/

// 4. éªŒè¯app.jsonå·²æ›´æ–°
âœ“ æ³¨å†Œæ–°é¡µé¢åˆ° pages æ•°ç»„

// 5. éªŒè¯ç°æœ‰é¡µé¢é›†æˆ
âœ“ habit-detail æœ‰ viewHistory(), editHabit(), deleteHabit()
âœ“ create-habit æœ‰ recordChanges() æ–¹æ³•å’Œ oldHabit æ•°æ®
âœ“ settings æœ‰ goToDeletedHabits() å’Œ goToDataExport()
```

### è°ƒç”¨ç¤ºä¾‹

#### ä¾‹1: è®°å½•ä¸€æ¬¡å˜æ›´

```javascript
// ç”¨æˆ·ç¼–è¾‘ä¹ æƒ¯ï¼Œæ”¹äº†"åç§°"
const res = await wx.cloud.callFunction({
  name: 'recordHabitChange',
  data: {
    user_habit_id: 'habit_123',
    field_changed: 'name',
    old_value: 'è·‘æ­¥',
    new_value: 'å¿«èµ°'
  }
});
// è¿”å›: { code: 0, data: { change_log_id: '...' } }
```

#### ä¾‹2: è·å–å˜æ›´å†å²

```javascript
const res = await wx.cloud.callFunction({
  name: 'getChangeHistory',
  data: {
    user_habit_id: 'habit_123',
    limit: 20  // å¯é€‰
  }
});
// è¿”å›: { code: 0, data: { change_logs: [...] } }
```

#### ä¾‹3: æ’¤é”€æŸä¸ªå˜æ›´

```javascript
const res = await wx.cloud.callFunction({
  name: 'undoHabitChange',
  data: {
    user_habit_id: 'habit_123',
    change_log_id: 'log_456'
  }
});
// æ“ä½œ: å°†åç§°æ”¹å›ä¸º old_value
// è¿”å›: { code: 0 }
```

#### ä¾‹4: è½¯åˆ é™¤ä¹ æƒ¯

```javascript
const res = await wx.cloud.callFunction({
  name: 'softDeleteHabit',
  data: {
    user_habit_id: 'habit_123'
  }
});
// è®¾ç½® status='deleted', recover_deadline = ç°åœ¨ + 30å¤©
// è¿”å›: { code: 0, data: { recover_deadline: æ—¶é—´æˆ³ } }
```

#### ä¾‹5: æ¢å¤å·²åˆ é™¤çš„ä¹ æƒ¯

```javascript
const res = await wx.cloud.callFunction({
  name: 'restoreDeletedHabit',
  data: {
    user_habit_id: 'habit_123'
  }
});
// æ£€æŸ¥30å¤©æœŸé™ â†’ è®¾ç½® status='active' â†’ è¿”å›
// è¿”å›: { code: 0, data: { habit: {...} } }
```

#### ä¾‹6: å¯¼å‡ºæ‰€æœ‰æ•°æ®

```javascript
const res = await wx.cloud.callFunction({
  name: 'exportUserData'
});
// è¿”å›: {
//   code: 0,
//   data: {
//     json: '{"export_time":"...", ...}',
//     csv: 'ID,åç§°,è§¦å‘å™¨,...',
//     total_habits: 8
//   }
// }
```

#### ä¾‹7: è·å–ç‰¹å®šçŠ¶æ€çš„ä¹ æƒ¯

```javascript
// è·å–å·²åˆ é™¤çš„ä¹ æƒ¯
const res = await wx.cloud.callFunction({
  name: 'getMyHabits',
  data: { status: 'deleted' }
});
// è¿”å›: { code: 0, data: [ä¹ æƒ¯1, ä¹ æƒ¯2, ...] }

// è·å–æ´»è·ƒä¹ æƒ¯ï¼ˆæˆ–ä¸ä¼ statusï¼‰
const res = await wx.cloud.callFunction({
  name: 'getMyHabits'
  // é»˜è®¤è¿”å› status='active' çš„ä¹ æƒ¯
});
```

---

## ğŸ“Š æ•°æ®ç»“æ„å‚è€ƒ

### change_logs æ–‡æ¡£ç¤ºä¾‹

```javascript
{
  "_id": "doc_123",
  "user_habit_id": "habit_456",
  "field_changed": "name",
  "old_value": "è·‘æ­¥",
  "new_value": "å¿«èµ°",
  "timestamp": 1705308600000,  // 2024-01-15 10:30:00
  "user_id": "openid_xxx",
  "_openid": "openid_xxx"
}
```

### user_habits æ–‡æ¡£ç¤ºä¾‹ï¼ˆè½¯åˆ é™¤ï¼‰

```javascript
{
  // ... åŸæœ‰å­—æ®µ
  "_id": "habit_456",
  "name": "è·‘æ­¥",
  "status": "deleted",  // å…³é”®ï¼
  "deleted_at": "2024-01-15T10:30:00Z",
  "recover_deadline": 1708014600000,  // 2024-02-15 10:30:00
  // å…¶ä»–å­—æ®µä¿ç•™ï¼Œæ–¹ä¾¿æ¢å¤
}
```

### å¯¼å‡ºæ•°æ®ç¤ºä¾‹

**JSONæ ¼å¼**:
```json
{
  "export_time": "2024-01-15 10:30:00",
  "user_id": "openid_xxx",
  "habits": [
    {
      "_id": "habit_1",
      "name": "è·‘æ­¥",
      "trigger": "æ—©ä¸Šèµ·åºŠ",
      "target_times_per_day": 1,
      "status": "active",
      "current_day": 15,
      "completed_days": 12,
      "total_days": 21
    },
    // ... æ›´å¤šä¹ æƒ¯
  ],
  "statistics": {
    "total_habits": 8,
    "active_habits": 6,
    "completed_habits": 2,
    "total_days": 168,
    "total_completed": 145
  }
}
```

**CSVæ ¼å¼**:
```
ID,åç§°,è§¦å‘å™¨,æ¯æ—¥æ¬¡æ•°,çŠ¶æ€,åˆ›å»ºæ—¶é—´,è¿›è¡Œå¤©æ•°,å®Œæˆå¤©æ•°,æ€»å¤©æ•°
habit_1,è·‘æ­¥,æ—©ä¸Šèµ·åºŠ,1,active,2024-01-01,15,12,21
habit_2,å†¥æƒ³,æ—©ä¸Šèµ·åºŠ,2,active,2024-01-02,14,10,21
```

---

## ğŸ¨ UIç»„ä»¶å‚è€ƒ

### æ—¶é—´çº¿é¡¹ç›® (habit-history)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â— â† è“è‰²åœ†ç‚¹ï¼ˆemojiè¡¨æƒ…ï¼‰             â”‚
â”‚   â”‚                                    â”‚
â”‚   â””â”€ å˜æ›´å¡ç‰‡                          â”‚
â”‚       ä¿®æ”¹æ—¶é—´ï¼š2å°æ—¶å‰                 â”‚
â”‚       ä¿®æ”¹å­—æ®µï¼šåç§°                     â”‚
â”‚       æ–°å€¼ï¼šå¿«èµ°                        â”‚
â”‚       [ç‚¹å‡»å±•å¼€]                        â”‚
â”‚                                        â”‚
â”‚       å±•å¼€å:                          â”‚
â”‚       ä¿®æ”¹å‰ï¼šè·‘æ­¥                      â”‚
â”‚       [æ¢å¤åˆ°æ­¤çŠ¶æ€] æŒ‰é’®               â”‚
â”‚                                        â”‚
â”‚  â— â† ä¸‹ä¸€æ¡å†å²                        â”‚
â”‚   â”‚                                    â”‚
â”‚   â””â”€ ...                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¢å¤å€’è®¡æ—¶è¿›åº¦æ¡ (deleted-habits)

```
å·²åˆ é™¤ä¹ æƒ¯å¡ç‰‡
â”œâ”€ åˆ é™¤æ—¥æœŸ: 2024-01-10
â”œâ”€ æ¢å¤å€’è®¡æ—¶:
â”‚  â–°â–°â–°â–°â–°â–‘â–‘â–‘â–‘â–‘â–‘  å‰©ä½™ 10 å¤©å¯æ¢å¤
â”‚  (ç»¿è‰²æ¸å˜)     (ç°è‰²èƒŒæ™¯)
â”œâ”€ ä¹ æƒ¯ä¿¡æ¯...
â””â”€ [æ¢å¤] [æ°¸ä¹…åˆ é™¤]
```

### æ•°æ®å¯¼å‡ºé¢„è§ˆ (data-export)

```
å¯¼å‡ºæ•°æ® ğŸ“Š

â–¼ å¯¼å‡ºç»Ÿè®¡
  ä¹ æƒ¯æ€»æ•°: 8
  å¯¼å‡ºæ—¶é—´: 2024-01-15 10:30:00

â–¼ é€‰æ‹©æ ¼å¼
  â—‹ JSON  â— CSV

â–¼ æ•°æ®é¢„è§ˆ
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ ID,åç§°,è§¦å‘å™¨,...      â”‚
  â”‚ habit_1,è·‘æ­¥,æ—©ä¸Šèµ·åºŠ   â”‚
  â”‚ habit_2,å†¥æƒ³,æ—©ä¸Šèµ·åºŠ   â”‚
  â”‚ ... (æ›´å¤šè¡Œ)            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[å¤åˆ¶æ•°æ®] [ä¸‹è½½] [é‡æ–°å¯¼å‡º]
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q: å¦‚æœç”¨æˆ·åœ¨å·²åˆ é™¤é¡µé¢è¶…è¿‡30å¤©æ‰æ‰“å¼€ï¼Ÿ
**A**: æ˜¾ç¤º"æ¢å¤æœŸå·²è¿‡æœŸ"ï¼Œ[æ¢å¤]æŒ‰é’®ç¦ç”¨ï¼Œç”¨æˆ·åªèƒ½[æ°¸ä¹…åˆ é™¤]ã€‚

### Q: èƒ½å¦å»¶é•¿30å¤©çš„æ¢å¤æœŸï¼Ÿ
**A**: å½“å‰ä¸æ”¯æŒã€‚å¯åœ¨ softDeleteHabit ä¸­ä¿®æ”¹ `30 * 24 * 60 * 60 * 1000` å¸¸é‡æ¥æ”¹å˜æ—¶é—´ã€‚

### Q: å˜æ›´å†å²èƒ½è®°å½•å¤šå°‘æ¡ï¼Ÿ
**A**: ç†è®ºä¸Šæ— é™åˆ¶ã€‚å»ºè®®ä½¿ç”¨ limit å‚æ•°é¿å…ä¸€æ¬¡åŠ è½½è¿‡å¤šæ•°æ®ã€‚

### Q: å¯¼å‡ºæ•°æ®èƒ½è‡ªåŠ¨ä¸‹è½½å—ï¼Ÿ
**A**: å½“å‰ä¸æ”¯æŒã€‚ç”¨æˆ·éœ€æ‰‹åŠ¨å¤åˆ¶æ•°æ®æˆ–ä¿å­˜ä¸ºæ–‡ä»¶ã€‚å¯é€šè¿‡æ‰©å±• exportUserData è¿”å›ä¸‹è½½é“¾æ¥æ¥æ”¹è¿›ã€‚

### Q: è½¯åˆ é™¤çš„ä¹ æƒ¯æ˜¯å¦è®¡å…¥ç»Ÿè®¡ï¼Ÿ
**A**: ä¸è®¡å…¥ã€‚ç»Ÿè®¡åªè€ƒè™‘ status='active' æˆ– status='completed' çš„ä¹ æƒ¯ã€‚

### Q: ç”¨æˆ·èƒ½å¦å¯¼å‡ºå·²åˆ é™¤çš„ä¹ æƒ¯ï¼Ÿ
**A**: å½“å‰ä¸èƒ½ã€‚exportUserData åªå¯¼å‡º status != 'deleted' çš„ä¹ æƒ¯ã€‚å¯æŒ‰éœ€ä¿®æ”¹ã€‚

---

## ğŸ”„ æ›´æ–°æ—¥å¿—

| ç‰ˆæœ¬ | æ—¥æœŸ | å†…å®¹ |
|------|------|------|
| 1.0 | 2024-01 | Phase 3.3-3.4 å®Œæ•´å®ç° |
| - | - | 6ä¸ªäº‘å‡½æ•° + 3ä¸ªUIé¡µé¢ |
| - | - | å®Œæ•´çš„å˜æ›´è®°å½•å’Œè½¯åˆ é™¤ç³»ç»Ÿ |

---

## ğŸ“ æ”¯æŒèµ„æº

- å®Œæ•´æ–‡æ¡£: `PHASE_3_3_3_4_COMPLETE.md`
- æ•°æ®åº“è®¾è®¡: `DATABASE_DESIGN.md`
- é¡¹ç›®çŠ¶æ€: `PROJECT_COMPLETE_REPORT.md`

---

**æœ€åæ›´æ–°**: 2024å¹´
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª
