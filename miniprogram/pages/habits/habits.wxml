<!-- 习惯库页 -->
<view class="container">
  <!-- Tab切换 -->
  <view class="tabs">
    <view class="tab {{currentTab === 0 ? 'active' : ''}}" bindtap="switchTab" data-index="0">
      习惯库
    </view>
    <view class="tab {{currentTab === 1 ? 'active' : ''}}" bindtap="switchTab" data-index="1">
      我的习惯
    </view>
  </view>

  <!-- 习惯库内容 -->
  <view class="tab-content" wx:if="{{currentTab === 0}}">
    <!-- P2: 习惯数量软限制提示 -->
    <view class="habit-limit-hint" wx:if="{{inProgressCount > 3}}">
      <view class="hint-icon">💡</view>
      <view class="hint-content">
        <view class="hint-title">习惯不在多</view>
        <view class="hint-text">先把现在的做轻松，再加新的也不迟</view>
      </view>
    </view>

    <!-- 搜索框 -->
    <view class="search-box">
      <view class="search-field">
        <text class="search-icon">🔍</text>
        <!-- P0-1: 优化搜索框占位文案 -->
        <input
          class="search-input"
          placeholder="想变轻一点？随便看看"
          bindinput="onSearchInput"
          bindconfirm="onSearchConfirm"
          value="{{searchQuery}}"
          confirm-type="search"
        />
        <view class="search-clear" wx:if="{{searchQuery}}" bindtap="clearSearch">✕</view>
      </view>
      <view class="search-hint">输入关键词或直接选分类，先挑轻松的开始</view>
    </view>

    <!-- 分类筛选 -->
    <scroll-view class="category-scroll" scroll-x>
      <view class="category-item {{selectedCategory === item.value ? 'active' : ''}}"
            wx:for="{{categories}}"
            wx:key="value"
            bindtap="selectCategory"
            data-value="{{item.value}}">
        {{item.label}}
      </view>
    </scroll-view>

    <!-- P0-1: 添加分类提示 -->
    <view class="category-hint">
      <text class="hint-icon">💡</text>
      <text class="hint-text">先选不费力的，其他可以以后再说</text>
    </view>

    <!-- 搜索历史 -->
    <view class="search-history" wx:if="{{!searchQuery && searchHistory.length > 0}}">
      <view class="history-title">最近搜过</view>
      <view class="history-tags">
          <view class="history-tag"
            wx:for="{{searchHistory}}"
            wx:key="*this"
            bindtap="selectHistory"
            data-keyword="{{item}}">
          {{item}}
        </view>
      </view>
    </view>

    <!-- 搜索结果提示 -->
    <view class="search-meta" wx:if="{{isSearching}}">
      找到 {{filteredTemplates.length}} 个习惯
    </view>

    <!-- 加载中 -->
    <view class="loading-skeleton" wx:if="{{loadingTemplates}}">
      <view class="skeleton-card"></view>
      <view class="skeleton-card"></view>
      <view class="skeleton-card"></view>
    </view>

    <!-- 模板列表 -->
    <view class="template-list" wx:if="{{!loadingTemplates && filteredTemplates.length > 0}}">
      <view class="template-card" wx:for="{{filteredTemplates}}" wx:key="_id">
        <view class="template-header">
          <view class="template-category">{{item.category_name}}</view>
        </view>
        <view class="template-name">{{item.name}}</view>
        <!-- P0-1: 触发条件弱化展示 -->
        <view class="template-trigger">在{{item.default_trigger}}</view>
        <!-- P0-1: 描述区优化，强调轻松感 -->
        <view class="template-desc-new">
          <text class="desc-time">只要 30 秒</text>
          <text class="desc-note">做不到也没关系</text>
        </view>
        <view class="template-desc-original" wx:if="{{item.description}}">{{item.description}}</view>
        <view class="btn-add-wrapper">
          <!-- P0-1: 添加按钮文案优化，从承诺改为尝试 -->
          <button class="btn-add" bindtap="addTemplate" data-id="{{item._id}}">
            <text class="btn-add-icon">+</text>
            <text class="btn-add-text">试试这个</text>
          </button>
        </view>
      </view>
    </view>

    <!-- 加载失败 -->
    <view class="error-state" wx:if="{{templateError}}">
      <view class="error-icon">😴</view>
      <view class="error-title">暂时无法加载</view>
      <view class="error-text">请检查网络连接后重试</view>
      <button class="btn btn-primary" bindtap="retryLoadTemplates">重新加载</button>
    </view>

    <!-- 空列表 -->
    <view class="empty-state" wx:if="{{!loadingTemplates && !templateError && filteredTemplates.length === 0}}">
      <view class="empty-icon">📭</view>
      <view class="empty-title">没有找到匹配的习惯</view>
      <view class="empty-text">{{searchQuery ? '换个关键词试试' : '从分类中选择或搜索习惯'}}</view>
    </view>
  </view>

  <!-- 我的习惯内容 -->
  <view class="tab-content" wx:if="{{currentTab === 1}}">
    <!-- 筛选/排序条 -->
    <view class="filter-bar" wx:if="{{!loadingMyHabits && !myHabitsError && myHabitsRaw.length > 0}}">
      <!-- 筛选组 -->
      <view class="filter-group">
        <view class="filter-label">筛选</view>
        <scroll-view class="filter-scroll" scroll-x>
          <view class="filter-item {{myHabitsFilter === 'all' ? 'active' : ''}}" bindtap="switchMyHabitsFilter" data-value="all">全部</view>
          <!-- P0-2: 优化状态文案，降低失败感 -->
          <view class="filter-item {{myHabitsFilter === 'in_progress' ? 'active' : ''}}" bindtap="switchMyHabitsFilter" data-value="in_progress">正在陪伴</view>
          <view class="filter-item {{myHabitsFilter === 'finished' ? 'active' : ''}}" bindtap="switchMyHabitsFilter" data-value="finished">暂时放下</view>
        </scroll-view>
      </view>

      <!-- 排序组 -->
      <view class="filter-group">
        <view class="filter-label">排序</view>
        <scroll-view class="filter-scroll" scroll-x>
          <view class="filter-item {{myHabitsSortBy === 'created' ? 'active' : ''}}" bindtap="switchMyHabitsSortBy" data-value="created">按创建</view>
          <view class="filter-item {{myHabitsSortBy === 'progress' ? 'active' : ''}}" bindtap="switchMyHabitsSortBy" data-value="progress">按进度</view>
          <!-- P1-2: 新增按今天最轻排序 -->
          <view class="filter-item {{myHabitsSortBy === 'easiest' ? 'active' : ''}}" bindtap="switchMyHabitsSortBy" data-value="easiest">按今天最轻</view>
        </scroll-view>
      </view>
    </view>

    <!-- 加载中 -->
    <view class="loading-skeleton" wx:if="{{loadingMyHabits}}">
      <view class="skeleton-item"></view>
      <view class="skeleton-item"></view>
      <view class="skeleton-item"></view>
    </view>

    <!-- 习惯列表 -->
    <view class="my-habits-list" wx:if="{{!loadingMyHabits && myHabits.length > 0}}">
      <view class="habit-item {{item.status === 'paused' ? 'paused' : ''}}"
            wx:for="{{myHabits}}"
            wx:key="_id"
            bindtap="goToDetail"
            data-id="{{item._id}}">
        <!-- 标题和状态芯片 -->
        <view class="habit-header">
          <view class="habit-name">{{item.name}}</view>
          <view class="habit-status-chip {{item.status}}">{{item.statusText}}</view>
        </view>
        <!-- 进度部分 -->
        <view class="habit-progress">
          <view class="habit-progress-text-warm">{{item.warmProgressText}}</view>
          <view class="habit-progress-bar">
            <view class="habit-progress-inner" style="width: {{item.progress.percentage}}%;"></view>
          </view>
        </view>
        <!-- 状态提示 -->
        <view class="habit-state-hint" wx:if="{{item.status === 'paused'}}">
          ⏸️ 已暂停，恢复后继续当前进度
        </view>
        <!-- 操作按钮 -->
        <view class="habit-actions" catchtap="stopPropagation">
          <button
            class="btn-habit-action {{item.status === 'paused' ? 'resume' : 'pause'}}"
            wx:if="{{item.status === 'in_progress'}}"
            bindtap="pauseHabit"
            data-id="{{item._id}}">
            暂时放下
          </button>
          <button
            class="btn-habit-action resume"
            wx:elif="{{item.status === 'paused' || item.status === 'finished'}}"
            bindtap="resumeHabit"
            data-id="{{item._id}}">
            继续陪伴
          </button>
        </view>
      </view>
    </view>

    <!-- 加载失败 -->
    <view class="error-state" wx:if="{{myHabitsError}}">
      <view class="error-icon">😴</view>
      <view class="error-title">暂时无法加载</view>
      <view class="error-text">请检查网络连接后重试</view>
      <button class="btn btn-primary" bindtap="retryLoadMyHabits">重新加载</button>
    </view>

    <!-- 空列表 -->
    <view class="empty-state" wx:if="{{!loadingMyHabits && !myHabitsError && myHabitsRaw.length === 0}}">
      <view class="empty-icon">🎯</view>
      <view class="empty-title">还没有养成习惯</view>
      <view class="empty-text">从习惯库中选择一个习惯，开启你的微习惯养成之旅</view>
      <view class="empty-action">
        <button class="empty-action-btn" bindtap="switchTab" data-index="0">去选择习惯</button>
      </view>
    </view>

    <!-- 筛选后无结果 -->
    <view class="empty-state" wx:if="{{!loadingMyHabits && !myHabitsError && myHabitsRaw.length > 0 && myHabits.length === 0}}">
      <view class="empty-icon">🔍</view>
      <view class="empty-title">没有符合条件的习惯</view>
      <view class="empty-text">切换筛选条件试试</view>
    </view>
  </view>
</view>
