<view class="container">
  <view class="page-container" wx:if="{{!loading && habit}}">
    <!-- ç®€åŒ–å¤´éƒ¨ï¼šæ ‡é¢˜ + çŠ¶æ€ + å•è¡Œå…ƒæ•°æ® -->
    <view class="header-card {{isPaused ? 'paused' : ''}}">
      <view class="header-row">
        <view class="title">{{habit.name}}</view>
        <view class="status-badge {{isPaused ? 'paused' : ''}}">
          {{isPaused ? 'â¸ï¸ å·²æš‚åœ' : 'âœ“ è¿›è¡Œä¸­'}}
        </view>
      </view>
      <view class="meta-line">
        <text class="meta-item" wx:if="{{habit.target_times_per_day}}">ç›®æ ‡ï¼š{{habit.target_times_per_day}}æ¬¡/å¤©</text>
        <text class="meta-divider">Â·</text>
        <text class="meta-item">æé†’ï¼š{{habit.trigger || habit.default_trigger || 'æœªè®¾ç½®'}}</text>
      </view>
      <view class="pause-hint" wx:if="{{isPaused}}">â¸ï¸ å·²æš‚åœï¼Œæ¢å¤åç»§ç»­å½“å‰è¿›åº¦</view>
    </view>

    <!-- ä¸»æ“ä½œï¼šæš‚åœ/ç»§ç»­ï¼ˆå…¨å®½ï¼‰ -->
    <view class="primary-action">
      <button
        class="btn-large {{isPaused ? 'resume' : 'pause'}}"
        bindtap="togglePauseHabit">
        {{isPaused ? 'ç»§ç»­é™ªä¼´' : 'æš‚æ—¶æ”¾ä¸‹'}}
      </button>
    </view>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <view class="stats-grid">
      <view class="stat-card">
        <view class="stat-value">{{stats.completion_rate}}%</view>
        <view class="stat-label">å®Œæˆç‡</view>
      </view>
      <view class="stat-card">
        <view class="stat-value">{{stats.completed_days}}/{{stats.total_days}}</view>
        <view class="stat-label">å·²å®Œæˆ</view>
      </view>
      <view class="stat-card">
        <view class="stat-value">{{stats.max_streak}}</view>
        <view class="stat-label">æœ€é•¿è¿ç»­</view>
      </view>
    </view>

    <!-- è¿›åº¦æ¡ -->
    <view class="progress-card">
      <view class="progress-text">ç¬¬ {{stats.progress.current}} / {{stats.progress.total}} å¤©</view>
      <view class="progress-bar">
        <view class="progress-inner" style="width: {{stats.progress.percentage}}%;"></view>
      </view>
    </view>

    <!-- å¿«é€Ÿç¼–è¾‘ï¼ˆä»…2è¡Œï¼šç›®æ ‡ + æé†’ï¼‰ -->
    <view class="quick-edit-card">
      <view class="edit-item" bindtap="showEditTargetModal">
        <view class="edit-label">æ¯æ—¥ç›®æ ‡æ¬¡æ•°</view>
        <view class="edit-value">{{habit.target_times_per_day || 1}} æ¬¡</view>
        <view class="edit-arrow">â€º</view>
      </view>
      <view class="divider"></view>
      <view class="edit-item" bindtap="showEditReminderModal">
        <view class="edit-label">æé†’æ—¶é—´</view>
        <view class="edit-value">{{habit.trigger || habit.default_trigger || 'æœªè®¾ç½®'}}</view>
        <view class="edit-arrow">â€º</view>
      </view>
    </view>

    <!-- 21å¤©æ—¥å† -->
    <view class="calendar-card">
      <view class="section-title">21 å¤©å®éªŒè¿›åº¦</view>
      <view class="calendar-grid">
        <block wx:for="{{calendar}}" wx:key="date">
          <view class="calendar-cell {{item.completed ? 'done' : ''}} {{item.isToday ? 'today' : ''}}"
                bindtap="selectCalendarDay"
                data-date="{{item.date}}"
                data-completed="{{item.completed}}"
                data-times="{{item.times}}">
            <text class="day">{{item.day}}</text>
          </view>
        </block>
      </view>
      <view class="legend">
        <view class="legend-item">
          <view class="legend-dot done"></view>
          <text>å·²å®Œæˆ</text>
        </view>
        <view class="legend-item">
          <view class="legend-dot today"></view>
          <text>ä»Šå¤©</text>
        </view>
      </view>
    </view>

    <!-- å»ºè®® -->
    <view class="advice-card" wx:if="{{advice}}">
      <view class="section-title">å»ºè®®</view>
      <view class="advice-text">{{advice}}</view>
    </view>

    <!-- æ¬¡çº§æ“ä½œæŒ‰é’®ï¼ˆæŸ¥çœ‹å†å² | åˆ é™¤ï¼‰ -->
    <view class="secondary-actions">
      <button class="btn-secondary" bindtap="viewHistory">
        ğŸ“š æŸ¥çœ‹å†å²
      </button>
      <button class="btn-secondary btn-danger" bindtap="deleteHabit">
        ğŸ—‘ï¸ åˆ é™¤ä¹ æƒ¯
      </button>
    </view>

    <!-- æ—¥æœŸè¯¦æƒ…å¼¹çª— -->
    <view class="modal-mask" wx:if="{{showDateModal}}" catchtap="closeDateModal">
      <view class="date-modal" catchtap>
        <view class="modal-date">{{selectedDateData.date}}</view>
        <view class="modal-completion">
          <view class="completion-item">
            <view class="completion-label">å®Œæˆæƒ…å†µ</view>
            <view class="completion-value">
              {{selectedDateData.completed ? 'âœ“ å·²å®Œæˆ' : 'å½“æ—¥ä¼‘æ¯'}}
            </view>
          </view>
          <view class="completion-item">
            <view class="completion-label">å®Œæˆæ¬¡æ•°</view>
            <view class="completion-value">{{selectedDateData.times}} / {{selectedDateData.targetTimes}}</view>
          </view>
        </view>
        <button class="btn btn-primary" bindtap="closeDateModal">å…³é—­</button>
      </view>
    </view>

    <!-- ç¼–è¾‘æ¯æ—¥ç›®æ ‡æ¬¡æ•°å¼¹çª— -->
    <view class="modal-mask" wx:if="{{showEditTargetModal}}" catchtap="closeEditTargetModal">
      <view class="edit-modal" catchtap>
        <view class="modal-title">è®¾ç½®æ¯æ—¥ç›®æ ‡æ¬¡æ•°</view>
        <view class="modal-description">è¿™ä¸ªä¹ æƒ¯æ¯å¤©è¦å®Œæˆå¤šå°‘æ¬¡ï¼Ÿ</view>

        <view class="number-picker">
          <button class="number-btn" data-action="decrease" bindtap="updateTargetTimes">âˆ’</button>
          <view class="number-display">{{editingTargetTimes}}</view>
          <button class="number-btn" data-action="increase" bindtap="updateTargetTimes">+</button>
        </view>

        <view class="modal-tip">ğŸ’¡ ä¿®æ”¹åï¼Œç³»ç»Ÿä¼šæ ¹æ®æ–°çš„ç›®æ ‡è°ƒæ•´æ‚¨çš„å®Œæˆç‡è®¡ç®—</view>

        <view class="modal-buttons">
          <button class="btn btn-cancel" bindtap="closeEditTargetModal">å–æ¶ˆ</button>
          <button class="btn btn-primary" bindtap="saveTargetTimes">ä¿å­˜</button>
        </view>
      </view>
    </view>

    <!-- ç¼–è¾‘æé†’æ—¶é—´å¼¹çª— -->
    <view class="modal-mask" wx:if="{{showEditReminderModal}}" catchtap="closeEditReminderModal">
      <view class="edit-modal" catchtap>
        <view class="modal-title">è®¾ç½®æé†’æ—¶é—´</view>
        <view class="modal-description">åœ¨ä»€ä¹ˆæ—¶å€™æé†’ä½ å®Œæˆè¿™ä¸ªä¹ æƒ¯ï¼Ÿ</view>

        <view class="input-box">
          <input
            class="modal-input"
            placeholder="ä¾‹å¦‚ï¼šåˆ·ç‰™åã€åˆé¤å‰ã€ä¸ŠåºŠå‰"
            placeholderClass="placeholder"
            value="{{editingReminder}}"
            bindinput="onReminderInput"
            maxlength="20"
          />
        </view>

        <view class="reminder-examples">
          <view class="example-title">å¸¸è§æé†’ï¼š</view>
          <view class="example-tags">
            <text class="tag">åˆ·ç‰™å</text>
            <text class="tag">åˆé¤å‰</text>
            <text class="tag">ä¸‹åˆ3ç‚¹</text>
            <text class="tag">ç¡å‰</text>
          </view>
        </view>

        <view class="modal-buttons">
          <button class="btn btn-cancel" bindtap="closeEditReminderModal">å–æ¶ˆ</button>
          <button class="btn btn-primary" bindtap="saveReminder">ä¿å­˜</button>
        </view>
      </view>
    </view>
  </view>

  <view wx:if="{{loading}}" class="loading">åŠ è½½ä¸­...</view>
</view>
