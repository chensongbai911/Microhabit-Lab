<view class="container">
  <view class="page-container" wx:if="{{!loading && habit}}">
    <!-- é¡¶éƒ¨ä¿¡æ¯ -->
    <view class="header-card">
      <view class="title">{{habit.name}}</view>
      <view class="meta">
        <text class="tag">{{categoryName || 'ä¹ æƒ¯'}}</text>
        <text class="tag" wx:if="{{habit.trigger || habit.default_trigger}}">è§¦å‘å™¨ï¼š{{habit.trigger || habit.default_trigger}}</text>
        <text class="tag" wx:if="{{habit.target_times_per_day}}">ç›®æ ‡/å¤©ï¼š{{habit.target_times_per_day}}</text>
      </view>
      <view class="desc" wx:if="{{habit.description}}">{{habit.description}}</view>
    </view>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <view class="stats-grid">
      <view class="stat-card">
        <view class="stat-value">{{stats.completion_rate}}%</view>
        <view class="stat-label">å®Œæˆç‡</view>
      </view>
      <view class="stat-card">
        <view class="stat-value">{{stats.completed_days}} / {{stats.total_days}}</view>
        <view class="stat-label">å·²å®Œæˆå¤©æ•°</view>
      </view>
      <view class="stat-card">
        <view class="stat-value">{{stats.max_streak}}</view>
        <view class="stat-label">æœ€é•¿è¿ç»­</view>
      </view>
    </view>

    <!-- è¿›åº¦æ¡ -->
    <view class="progress-card">
      <view class="progress-text">ç¬¬ {{stats.progress.current}} / {{stats.progress.total}} å¤©</view>
      <view class="progress-bar">
        <view class="progress-inner" style="width: {{stats.progress.percentage}}%;"></view>
      </view>
    </view>

    <!-- 21å¤©æ—¥å† -->
    <view class="calendar-card">
      <view class="section-title">21 å¤©å®éªŒè¿›åº¦</view>
      <view class="calendar-grid">
        <block wx:for="{{calendar}}" wx:key="date">
          <view class="calendar-cell {{item.completed ? 'done' : ''}} {{item.isToday ? 'today' : ''}}"
                bindtap="selectCalendarDay"
                data-date="{{item.date}}"
                data-completed="{{item.completed}}"
                data-times="{{item.times}}">
            <text class="day">{{item.day}}</text>
          </view>
        </block>
      </view>
      <view class="legend">
        <view class="legend-item">
          <view class="legend-dot done"></view>
          <text>å·²å®Œæˆ</text>
        </view>
        <view class="legend-item">
          <view class="legend-dot today"></view>
          <text>ä»Šå¤©</text>
        </view>
        <view class="legend-item">
          <view class="legend-dot normal"></view>
          <text>æœªå®Œæˆ</text>
        </view>
      </view>
    </view>

    <!-- å»ºè®® -->
    <view class="advice-card" wx:if="{{advice}}">
      <view class="section-title">å»ºè®®</view>
      <view class="advice-text">{{advice}}</view>
    </view>

    <!-- æ“ä½œåŒºåŸŸ -->
    <view class="actions-card">
      <view class="action-buttons">
        <button class="btn-history" bindtap="viewHistory">
          ğŸ“‹ æŸ¥çœ‹å†å²
        </button>
        <button class="btn-edit" bindtap="editHabit">
          âœï¸ ç¼–è¾‘
        </button>
        <button class="btn-delete" bindtap="deleteHabit">
          ğŸ—‘ï¸ åˆ é™¤
        </button>
      </view>
    </view>

    <!-- æ—¥æœŸè¯¦æƒ…å¼¹çª— -->
    <view class="modal-mask" wx:if="{{showDateModal}}" catchtap="closeDateModal">
      <view class="date-modal" catchtap>
        <view class="modal-date">{{selectedDateData.date}}</view>
        <view class="modal-completion">
          <view class="completion-item">
            <view class="completion-label">å®Œæˆæƒ…å†µ</view>
            <!-- P2: ç§»é™¤è´Ÿé¢æ–‡æ¡ˆï¼Œä½¿ç”¨æ›´ä¸­æ€§çš„è¡¨è¿° -->
            <view class="completion-value">
              {{selectedDateData.completed ? 'âœ“ å·²å®Œæˆ' : 'å½“æ—¥ä¼‘æ¯'}}
            </view>
          </view>
          <view class="completion-item">
            <view class="completion-label">å®Œæˆæ¬¡æ•°</view>
            <view class="completion-value">{{selectedDateData.times}} / {{selectedDateData.targetTimes}}</view>
          </view>
        </view>
        <button class="btn btn-primary" bindtap="closeDateModal">å…³é—­</button>
      </view>
    </view>
  </view>

  <view wx:if="{{loading}}" class="loading">åŠ è½½ä¸­...</view>
</view>
