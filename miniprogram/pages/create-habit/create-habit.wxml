<!-- æ–°å»º/ç¼–è¾‘ä¹ æƒ¯é¡µ -->
<view class="container">
  <view class="page-container">
    <!-- æ ‡é¢˜å’Œæç¤º -->
    <view class="header">
      <view class="title">{{pageTitle}}</view>
      <!-- Phase 1æ”¹è¿›: ç¼–è¾‘æ¨¡å¼æ˜¾ç¤ºè¿›åº¦ä¿¡æ¯ -->
      <view class="subtitle" wx:if="{{mode === 'create'}}">å†™ä¸‹ä¸€ä¸ª30ç§’å†…èƒ½å®Œæˆçš„å°åŠ¨ä½œ</view>
      <view class="habit-status" wx:else>
        <view class="status-item">
          <text class="status-label">å·²è¿›è¡Œ</text>
          <text class="status-value">{{habitStatus.currentDay}}/{{habitStatus.totalDays}}å¤©</text>
        </view>
        <view class="status-item">
          <text class="status-label">å®Œæˆç‡</text>
          <text class="status-value">{{habitStatus.completionRate}}%</text>
        </view>
        <view class="status-item">
          <text class="status-label">æœ€åå®Œæˆ</text>
          <text class="status-value">{{habitStatus.lastCompletedAt}}</text>
        </view>
      </view>
    </view>

    <!-- è¡¨å• -->
    <view class="form">
      <!-- ä¹ æƒ¯åç§° -->
      <view class="form-item">
        <view class="form-label">ä¹ æƒ¯åç§°</view>
        <input class="form-input"
               placeholder="ä¾‹: åˆ·ç‰™åå–ä¸€å£æ°´ / ç¡å‰å†™1å¥è¯æ—¥è®°"
               value="{{formData.name}}"
               maxlength="30"
               bindinput="handleNameInput" />
        <view class="form-hint">
          <text class="text-tertiary">ä¸è¦å†™æˆ"æ¯å¤©è·‘æ­¥5å…¬é‡Œ",å…ˆä»"ç©¿ä¸Šè·‘é‹èµ°å‡ºé—¨100ç±³"å¼€å§‹</text>
          <view class="form-feedback">
            <text class="char-count">{{nameLength}}/30</text>
            <text class="feedback-status" wx:if="{{nameFeedback}}">{{nameFeedback}}</text>
          </view>
        </view>
        <!-- æ¨èæç¤º -->
        <view class="recommendation-hint" wx:if="{{formData.name.length > 0}}">
          <text class="hint-icon">ğŸ’¡</text>
          <text class="hint-text">æ¨è <strong>{{triggerCategories[selectedTriggerCategory].label}}</strong> æ—¶é—´æ®µçš„è§¦å‘å™¨</text>
        </view>
      </view>

      <!-- è§¦å‘å™¨åˆ†ç±»é€‰æ‹© -->
      <view class="form-item">
        <view class="form-label">è¯·é€‰æ‹©ä¸€ä¸ªå¸¸è§æ—¶æœºï¼ˆä¹Ÿå¯ä»¥è‡ªå®šä¹‰ï¼‰</view>
        <view class="form-sublabel">é€‰æ‹©ä½ å·²æœ‰çš„æ—¥å¸¸æ´»åŠ¨ä½œä¸ºä¹ æƒ¯æ—¶æœºï¼Œæ¯”å¦‚â€œåˆ·ç‰™åâ€â€œåˆé¤å‰â€æ›´å®¹æ˜“åšæŒ</view>
        <view class="trigger-categories">
          <view wx:for="{{allCategories}}"
                wx:key="key"
                class="category-tag {{selectedTriggerCategory === item.key ? 'active' : ''}}"
                data-category="{{item.key}}"
                bindtap="handleTriggerCategorySelect">
            <text class="category-icon">{{item.icon}}</text>
            <text class="category-name">{{item.label}}</text>
          </view>
        </view>
      </view>

      <!-- è§¦å‘å™¨åˆ—è¡¨ -->
      <view class="form-item">
        <view class="trigger-list">
          <view wx:for="{{recommendedTriggers}}"
                wx:key="value"
                class="trigger-option {{formData.trigger === item.value ? 'selected' : ''}} {{item.value === 'other' ? 'trigger-other' : ''}}"
                data-value="{{item.value}}"
                bindtap="handleTriggerSelect">
            <text class="trigger-icon">{{item.icon}}</text>
            <view class="trigger-info">
              <text class="trigger-label">{{item.value === 'other' ? 'è‡ªå®šä¹‰æ—¶æœº' : item.label}}</text>
              <text class="trigger-time">{{item.time}}</text>
            </view>
            <!-- å®Œæˆç‡æ•°æ®æ˜¾ç¤º -->
            <view class="trigger-stats" wx:if="{{item.completionRate > 0}}">
              <text class="stat-completion">{{item.completionRate}}%</text>
              <text class="stat-label">å®Œæˆç‡</text>
            </view>
            <text class="trigger-checkmark" wx:if="{{formData.trigger === item.value}}">âœ“</text>
          </view>
        </view>

        <!-- è‡ªå®šä¹‰è§¦å‘å™¨è¾“å…¥ -->
        <view class="custom-trigger" wx:if="{{formData.trigger === 'other'}}">
          <view class="custom-trigger-hint">
            <text class="hint-icon">ğŸ’¡</text>
            <text class="hint-text">æ²¡æœ‰åˆé€‚çš„ï¼Ÿè¯·å¡«å†™ä½ è‡ªå·±çš„ä¹ æƒ¯æ—¶æœº</text>
          </view>
          <input class="form-input"
                 placeholder="å¦‚ï¼šåˆ·ç‰™åã€ä¸‹ç­å"
                 value="{{formData.customTrigger}}"
                 bindinput="handleCustomTriggerInput"
                 maxlength="20" />
        </view>
      </view>

      <!-- æé†’æ—¶é—´é¢„è§ˆ -->
      <view class="form-item" wx:if="{{formData.trigger}}">
        <view class="reminder-preview-vertical">
          <view class="reminder-main">
            <view class="reminder-icon">ğŸ””</view>
            <view class="reminder-info">
              <text class="reminder-label">æˆ‘ä»¬ä¼šåœ¨
                <picker mode="time" value="{{reminderTime}}" bindchange="onTimeChange" wx:if="{{formData.trigger === 'other'}}">
                  <view class="reminder-time-picker-wrapper">
                    <text class="reminder-time reminder-time-picker">{{reminderTime}}</text>
                    <text class="picker-hint">âœï¸</text>
                  </view>
                </picker>
                <text class="reminder-time" wx:else>{{reminderTime}}</text>
                æé†’ä½ å®Œæˆä¹ æƒ¯
              </text>
            </view>
          </view>
          <view class="reminder-tip-vertical">
            <text class="tip-text">åŸºäº"{{formData.trigger === 'other' ? formData.customTrigger : formData.trigger}}"è‡ªåŠ¨å®‰æ’</text>
            <text class="tip-text" wx:if="{{formData.trigger === 'other'}}"> Â· ç‚¹å‡»æ—¶é—´å¯ä¿®æ”¹</text>
          </view>
        </view>
      </view>

      <!-- æ‰§è¡Œé¢‘æ¬¡ -->
      <view class="form-item frequency-section">
        <view class="form-label">æ¯å¤©æ‰§è¡Œå‡ æ¬¡?</view>
        <view class="frequency-options">
          <view wx:for="{{frequencyOptions}}"
                wx:key="*this"
                class="frequency-btn {{formData.target_times_per_day === item ? 'active' : ''}}"
                bindtap="handleFrequencySelect"
                data-value="{{item}}">
            <view class="frequency-main">æ¯å¤©{{item}}æ¬¡</view>
            <!-- P0-1: å¼ºåŒ–æ¯å¤©1æ¬¡=æœ€ä¼˜ -->
            <view class="frequency-sub" wx:if="{{item === 1}}">æœ€å®¹æ˜“åšæŒ</view>
          </view>
        </view>

        <!-- P0-1: æ·»åŠ è­¦å‘Šæ–‡æ¡ˆ -->
        <view class="frequency-warning" wx:if="{{formData.target_times_per_day > 1}}">
          <text class="warning-icon">âš ï¸</text>
          <text class="warning-text">æ¬¡æ•°è¶Šå¤šï¼Œè¶Šå®¹æ˜“æ”¾å¼ƒ</text>
        </view>

        <!-- å®Œæˆç‡é¢„æµ‹ -->
        <view class="frequency-impact" wx:if="{{completionRateText}}">
          <view class="impact-content">
            <text class="impact-label-new">{{completionRateText}}</text>
            <text class="impact-tips">{{frequencyImpactTips}}</text>
          </view>
        </view>

        <!-- å½±å“åˆ†æè­¦å‘Š (ç¼–è¾‘æ¨¡å¼) -->
        <view class="impact-analysis" wx:if="{{impactAnalysis.show}}" style="border-left: 4px solid {{impactAnalysis.color}};">
          <view class="impact-header">
            <text class="impact-severity {{impactAnalysis.severity}}">
              {{impactAnalysis.severity === 'info' ? 'â„¹ï¸' : impactAnalysis.severity === 'warning' ? 'âš ï¸' : 'âŒ'}}
              {{impactAnalysis.severity === 'info' ? 'æç¤º' : impactAnalysis.severity === 'warning' ? 'è­¦å‘Š' : 'é£é™©'}}
            </text>
          </view>
          <text class="impact-message">{{impactAnalysis.message}}</text>
          <view class="impact-list" wx:if="{{impactAnalysis.impacts.length > 0}}">
            <view class="impact-item-small" wx:for="{{impactAnalysis.impacts}}" wx:key="index">
              <text class="impact-bullet">â€¢</text>
              <text class="impact-detail">{{item}}</text>
            </view>
          </view>
          <text class="impact-recommendation" wx:if="{{impactAnalysis.recommendation}}">ğŸ’¡ {{impactAnalysis.recommendation}}</text>
        </view>
      </view>
    </view>

    <!-- åº•éƒ¨æŒ‰é’® -->
    <view class="footer-actions">
      <button class="btn btn-outline" bindtap="handleCancel">å–æ¶ˆ</button>
      <!-- P0-2: åˆ›å»ºæŒ‰é’®å»æ‰¿è¯ºåŒ– -->
      <button class="btn btn-primary" bindtap="handleSubmit" disabled="{{!canSubmit}}">
        {{mode === 'edit' ? 'ä¿å­˜' : 'ä»ä»Šå¤©è¯•è¯•'}}
      </button>
    </view>

    <!-- P0-2: æ·»åŠ åº•éƒ¨å®‰æŠšè¯´æ˜ -->
    <view class="footer-hint" wx:if="{{mode === 'create'}}">
      <text class="hint-text">éšæ—¶å¯ä»¥æ”¹ï¼Œä¸ä¼šæ¸…é›¶</text>
    </view>
  </view>
</view>
