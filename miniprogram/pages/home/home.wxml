<!-- ä»Šæ—¥ä¹ æƒ¯é¡µ -->
<view class="container">
  <!-- é¡¶éƒ¨æ—¥æœŸå’Œé¼“åŠ±è¯­ -->
  <view class="header">
    <view class="header-top">
      <view>
        <!-- P1-1: ä½¿ç”¨æ¸©æš–æ ‡é¢˜ -->
        <view class="date">{{topStatusText || dateDisplay}}</view>
        <view class="encouragement">{{encouragementText}}</view>
      </view>
      <view class="header-actions">
        <!-- P1-1: æ˜¾ç¤ºå®Œæˆè¿›åº¦æ•°å­—ï¼Œè€Œéç™¾åˆ†æ¯” -->
        <view class="header-stats" wx:if="{{habits.length > 0}}">
          <view class="stat-item">
            <view class="stat-label">ä»Šæ—¥</view>
            <view class="stat-value">{{completedCount}}/{{totalCount}}</view>
          </view>
        </view>
        <view class="settings-btn" bindtap="goToSettings">
          <!-- ä½¿ç”¨emojiä½œä¸ºå›¾æ ‡,å¦‚éœ€PNGè¯·æ›¿æ¢ä¸ºimageæ ‡ç­¾ -->
        </view>
      </view>
    </view>

    <!-- å®Œæˆåº¦è¿›åº¦æ¡ -->
    <view class="progress-bar" wx:if="{{habits.length > 0}}">
      <view class="progress-fill" style="width: {{completionRate}}%;"></view>
    </view>
  </view>

  <!-- å…¨éƒ¨å®Œæˆæç¤º -->
  <view class="completed-banner" wx:if="{{showCompletedAnimation}}">
    <view class="completed-icon">ğŸ‰</view>
    <view class="completed-text">å¤ªæ£’äº†ï¼ä»Šå¤©çš„å¾®ä¹ æƒ¯å…¨éƒ¨å®Œæˆ!</view>
    <!-- ç²’å­ç‰¹æ•ˆ -->
    <view class="confetti-container">
      <view class="confetti" wx:for="{{[1,2,3,4,5,6,7,8]}}"></view>
    </view>
  </view>

  <!-- P0-1: æ‰“å¡æƒ…ç»ªåé¦ˆæµ®å±‚ -->
  <view class="emotion-feedback-toast {{showEmotionFeedback ? 'show' : ''}}" wx:if="{{showEmotionFeedback}}">
    <view class="emotion-feedback-text">{{emotionFeedbackText}}</view>
  </view>

  <!-- åŠ è½½ä¸­ -->
  <view class="loading-state" wx:if="{{loading}}">
    <view class="spinner"></view>
    <view class="loading-text">åŠ è½½ä¸­...</view>
  </view>

  <!-- åŠ è½½å¤±è´¥ -->
  <view class="error-state" wx:if="{{loadError && !loading}}">
    <view class="error-icon">ğŸ˜´</view>
    <view class="error-title">æš‚æ—¶æ— æ³•åŠ è½½</view>
    <view class="error-text">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•</view>
    <button class="btn btn-primary mt-lg" bindtap="retryLoadTodayHabits">é‡æ–°åŠ è½½</button>
  </view>

  <!-- ä¹ æƒ¯åˆ—è¡¨ -->
  <view class="habits-container" wx:if="{{habits.length > 0 && !loading && !loadError}}">
    <view class="habit-card-wrapper" wx:for="{{habits}}" wx:key="_id">
      <view class="habit-card {{editingId === item._id ? 'editing' : ''}}"
            bindtap="handleCardTap"
            bindlongpress="showHabitMenu"
            data-id="{{item._id}}"
            data-name="{{item.name}}">
        <view class="habit-main">
          <!-- å·¦ä¾§:å®Œæˆå›¾æ ‡ -->
          <view class="check-icon" wx:if="{{item.is_completed}}">
            <image src="/assets/icons/check.png" mode="aspectFit" />
          </view>
          <view class="check-placeholder" wx:else></view>

          <!-- ä¸­é—´:ä¹ æƒ¯ä¿¡æ¯ -->
          <view class="habit-info">
            <view class="habit-header">
              <view class="habit-name {{item.is_completed ? 'completed' : ''}}">{{item.name}}</view>
              <!-- P0-2: ä½¿ç”¨æ¸©æš–æ–‡æ¡ˆæ›¿ä»£ Day X/Y -->
              <view class="habit-period warm" wx:if="{{item.warmProgressText}}">{{item.warmProgressText}}</view>
            </view>
            <view class="habit-meta">
              <view class="trigger-tag tag-primary">{{item.trigger}}</view>
              <view class="progress-text">{{item.today_times}}/{{item.target_times_per_day}}</view>
            </view>
            <!-- è¿›åº¦æ¡ -->
            <view class="habit-progress-bar">
              <view class="habit-progress-fill" style="width: {{(item.today_times / item.target_times_per_day) * 100}}%;"></view>
            </view>
          </view>

          <!-- å³ä¾§:æ‰“å¡æŒ‰é’® -->
          <view class="check-in-btn {{item.is_completed ? 'disabled' : ''}} {{checkingInId === item._id ? 'loading' : ''}}"
                bindtap="handleCheckIn"
                data-id="{{item._id}}"
                data-completed="{{item.is_completed}}">
            <view wx:if="{{checkingInId === item._id}}" class="btn-spinner"></view>
            <image wx:else src="/assets/icons/{{item.is_completed ? 'check-circle-filled.png' : 'check-circle.png'}}" mode="aspectFit" />
          </view>
        </view>
      </view>
      <!-- æ»‘åŠ¨åˆ é™¤èœå• -->
      <view class="habit-actions" wx:if="{{editingId === item._id}}">
        <view class="action-btn action-edit" bindtap="editHabit" data-id="{{item._id}}">ç¼–è¾‘</view>
        <view class="action-btn action-delete" bindtap="deleteHabit" data-id="{{item._id}}">åˆ é™¤</view>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{habits.length === 0 && !loading && !loadError}}">
    <view class="empty-icon">ğŸ¯</view>
    <view class="empty-title">ä»Šå¤©è¿˜æ²¡æœ‰è¦åšçš„å¾®ä¹ æƒ¯</view>
    <view class="empty-text">ä»ä¸€ä¸ªå°åŠ¨ä½œå¼€å§‹å§</view>
    <button class="btn btn-primary mt-lg" bindtap="goToHabits">å»ä¹ æƒ¯åº“çœ‹çœ‹</button>
  </view>

  <!-- å‘¨æœŸç»“æŸå¼¹çª— -->
  <view class="modal-mask" wx:if="{{showEndModal}}" catchtap="hideEndModal">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-title">21å¤©å®éªŒç»“æŸ</view>
      <view class="modal-habit-name">{{endedHabit.name}}</view>
      <view class="modal-text">
        åœ¨è¿™21å¤©é‡Œ,ä½ åœ¨ <text class="highlight">{{endedHabit.completed_days}}/21</text> å¤©å®Œæˆäº†è¿™ä¸ªå¾®ä¹ æƒ¯,å®Œæˆç‡ <text class="highlight">{{endedHabit.completion_rate}}%</text>
      </view>

      <view class="modal-actions">
        <button class="btn btn-outline" bindtap="continueHabit">ç»§ç»­ä¸‹ä¸€è½®21å¤©</button>
        <button class="btn btn-text" bindtap="adjustHabit">æ”¹å°ä¸€ç‚¹</button>
        <button class="btn btn-text" bindtap="pauseHabit">å…ˆæš‚åœ</button>
      </view>
    </view>
  </view>

  <!-- èœå•è¦†ç›–å±‚ - ç”¨äºå…³é—­èœå• -->
  <view class="menu-overlay" wx:if="{{editingId}}" bindtap="handleCardTap" data-id="{{editingId}}"></view>

  <!-- Phase 3æ–°å¢: æ¨èä¹ æƒ¯åŒºåŸŸ -->
  <view class="recommended-section" wx:if="{{showRecommendation && recommendedHabits && recommendedHabits.length > 0}}">
    <view class="recommended-header">
      <!-- P1-2: æ¨èåŒºå»å‹åŠ›åŒ–æ–‡æ¡ˆ -->
      <text class="recommended-title">ğŸ’¡ è¦ä¸è¦å†è½»ä¸€ç‚¹ï¼Ÿ</text>
      <text class="recommended-subtitle">ä¸å¢åŠ è´Ÿæ‹…çš„å°ä¹ æƒ¯</text>
    </view>

    <view class="recommended-items">
      <view wx:for="{{recommendedHabits}}"
            wx:key="name"
            class="recommended-item"
            data-habit="{{item}}"
            bindtap="addRecommendedHabit">
        <view class="recommended-content">
          <view class="recommended-name">{{item.name}}</view>
          <view class="recommended-desc">{{item.description}}</view>
          <view class="recommended-reason">ğŸ’¡ {{item.reason}}</view>
        </view>
        <view class="recommended-stats">
          <text class="stat-rate">{{item.completionRate}}%</text>
          <text class="stat-label">å®Œæˆç‡</text>
        </view>
        <view class="recommended-action">
          <text class="action-text">+</text>
        </view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ–°å»ºæŒ‰é’® -->
  <view class="fab" bindtap="goToCreate">
    <image src="/assets/icons/plus.png" mode="aspectFit" />
  </view>
</view>

