<!-- å¾®ä¿¡å°ç¨‹åºç‰ˆé¦–é¡µ -->
<view class="container">
  <!-- ä¸»æ ‡é¢˜åŒºåŸŸ -->
  <view class="hero-section">
    <view class="hero-title">ä»Šå¤©ï¼Œä»å°å¼€å§‹</view>
    <view class="hero-subtitle">æ¯ä¸€ä¸ªå¾®å°è¡ŒåŠ¨ï¼Œéƒ½æ˜¯ä¼Ÿå¤§æ”¹å˜çš„å¼€å§‹</view>
  </view>

  <!-- é¦–æ¬¡é•¿æŒ‰æç¤º -->
  <view class="longpress-hint" wx:if="{{showLongpressHint}}">é•¿æŒ‰æ‰“å¡å¯æ’¤é”€å·²å®Œæˆï¼Œè¯•è¯•é•¿æŒ‰å·¦ä¾§åœ†åœˆ</view>

  <!-- æ¿€åŠ±åŒºåŸŸ -->
  <view class="encouragement-section" wx:if="{{!loading && !loadError && habits.length > 0}}">
    <view class="encouragement-card">
      <view class="encouragement-icon">ğŸ’ª</view>
      <view class="encouragement-text">{{encouragementText}}</view>
      <view class="encouragement-progress">å·²å®Œæˆ {{completedCount}}/{{totalCount}}</view>
      <view class="encouragement-bar">
        <view class="encouragement-fill" style="width: {{progress}}%"></view>
      </view>
    </view>
  </view>

  <!-- P0: å‘¨æœŸè®¡æ—¶å™¨å¡ç‰‡ -->
  <view class="cycle-timer-card" wx:if="{{!loading && !loadError && habits.length > 0}}">
    <view class="cycle-header">
      <view class="cycle-title">ğŸ“… 21å¤©å‘¨æœŸè¿›åº¦</view>
      <view class="cycle-badge {{cycleStatus}}" wx:if="{{cycleStatus === 'critical'}}">
        å³å°†å®Œæˆï¼
      </view>
    </view>

    <view class="cycle-main">
      <view class="cycle-number">
        <view class="current-day">{{currentCycleDay}}</view>
        <view class="total-day">/21</view>
      </view>
      <view class="cycle-progress-container">
        <view class="cycle-progress-bar">
          <view class="cycle-progress-fill" style="width: {{cyclePercentage}}%;"></view>
        </view>
        <view class="cycle-percentage">{{cyclePercentage}}%</view>
      </view>
    </view>

    <!-- å‘¨æœŸçŠ¶æ€æ–‡æ¡ˆ -->
    <view class="cycle-status-text">
      <view wx:if="{{cycleStatus === 'early'}}">ğŸŒ± åšæŒä¸‹å»ï¼Œå…»æˆå¥½ä¹ æƒ¯åªéœ€è¦21å¤©ï¼</view>
      <view wx:elif="{{cycleStatus === 'middle'}}">ğŸš€ è¿›åº¦è¿‡åŠï¼ŒåšæŒå°±æ˜¯èƒœåˆ©ï¼</view>
      <view wx:elif="{{cycleStatus === 'final'}}">ğŸ’ª å³å°†å®Œæˆï¼Œå†åŠ æ²¹ä¸€ä¸‹ï¼</view>
      <view wx:elif="{{cycleStatus === 'critical'}}">ğŸ‰ å°±å·®ä¸€ç‚¹äº†ï¼Œå†²åˆºå§ï¼</view>
    </view>

    <!-- å‘¨æœŸè¯¦æƒ… -->
    <view class="cycle-details">
      <view class="detail-item">
        <view class="detail-label">å·²åšæŒ</view>
        <view class="detail-value">{{currentCycleDay}} å¤©</view>
      </view>
      <view class="detail-item">
        <view class="detail-label">å‰©ä½™</view>
        <view class="detail-value">{{21 - currentCycleDay}} å¤©</view>
      </view>
      <view class="detail-item">
        <view class="detail-label">å®Œæˆç‡</view>
        <view class="detail-value">{{cyclePercentage}}%</view>
      </view>
    </view>
  </view>

  <!-- åŠ è½½ä¸­ -->
  <view class="loading-state" wx:if="{{loading}}">
    <view class="spinner"></view>
    <view class="loading-text">åŠ è½½ä¸­...</view>
  </view>

  <!-- åŠ è½½å¤±è´¥ -->
  <view class="error-state" wx:elif="{{loadError}}">
    <view class="error-icon">ğŸ˜´</view>
    <view class="error-title">æš‚æ—¶æ— æ³•åŠ è½½</view>
    <view class="error-text">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•</view>
    <button class="btn btn-primary" bindtap="retryLoadTodayHabits">é‡æ–°åŠ è½½</button>
  </view>

  <!-- ä¹ æƒ¯åˆ—è¡¨ -->
  <view class="habits-list" wx:elif="{{habits.length > 0}}">
      <view class="habit-card {{item.is_completed ? 'is-completed' : ''}}"
        wx:for="{{habits}}"
        wx:key="_id"
        bindlongpress="showHabitMenu"
        data-id="{{item._id}}">

      <!-- å³ä¸Šè§’æ’¤é”€ï¼ˆä½¿ç”¨ viewï¼Œé¿å… button é»˜è®¤æ ·å¼ï¼‰ -->
      <view wx:if="{{item.is_completed}}"
        class="undo-btn"
        data-id="{{item._id}}"
        data-completed="{{item.is_completed}}"
        bindtap="undoCheckIn">
        æ’¤é”€
      </view>

      <!-- å·¦ä¾§å®ŒæˆçŠ¶æ€ -->
      <view class="habit-check"
        bindtap="handleCheckIn"
        bindlongpress="undoCheckIn"
        data-id="{{item._id}}"
        data-completed="{{item.is_completed}}"
        catchlongpress="undoCheckIn">
        <view class="check-circle {{item.is_completed ? 'checked' : ''}}">
          <text wx:if="{{item.is_completed}}" class="check-text">âœ“</text>
        </view>
      </view>

      <!-- ä¹ æƒ¯ä¿¡æ¯ -->
      <view class="habit-content">
        <view class="habit-name">{{item.name}}</view>
        <view class="habit-progress">{{item.today_times}}/{{item.target_times_per_day}} {{item.unit || 'æ¬¡'}}</view>

        <!-- è¿›åº¦æ¡ -->
        <view class="progress-bar">
          <view class="progress-fill {{item.is_completed ? 'completed' : ''}}"
                style="width: {{item.progressPercent}}%"></view>
        </view>

        <!-- æ ‡ç­¾å’Œå®Œæˆç‡ -->
        <view class="habit-meta">
          <view class="habit-tags">
            <view class="tag tag-trigger">{{item.trigger}}</view>
            <view class="tag tag-category">æ¯æ—¥</view>
          </view>
          <view class="habit-completion {{item.is_completed ? 'completed' : ''}}">
            {{item.is_completed ? 'å·²å®Œæˆ' : (item.progressPercent + '%')}}
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:else>
    <view class="empty-icon">ğŸ¯</view>
    <view class="empty-title">ä»Šå¤©è¿˜æ²¡æœ‰è¦åšçš„å¾®ä¹ æƒ¯</view>
    <view class="empty-text">ä»ä¸€ä¸ªå°åŠ¨ä½œå¼€å§‹å§</view>
    <button class="btn btn-primary" bindtap="goToHabits">å»ä¹ æƒ¯åº“çœ‹çœ‹</button>
  </view>

  <!-- æ‰“å¡æˆåŠŸæç¤º -->
  <view class="toast {{showEmotionFeedback ? 'show' : ''}}" wx:if="{{showEmotionFeedback}}">
    <view class="toast-text">{{emotionFeedbackText}}</view>
  </view>

  <!-- å‘¨æœŸç»“æŸå¼¹çª— -->
  <view class="cycle-end-modal" wx:if="{{showEndModal}}">
    <view class="modal-overlay" bindtap="hideEndModal"></view>
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-emoji">ğŸ‰</text>
        <text class="modal-title">21 å¤©å®éªŒç»“æŸ</text>
      </view>

      <view class="modal-body">
        <view class="habit-name">{{endedHabit.name}}</view>
        <view class="habit-stats">
          <text class="stat-label">å®Œæˆå¤©æ•°</text>
          <text class="stat-value">{{endedHabit.completed_days || 0}} / {{endedHabit.cycle_days || 21}}</text>
        </view>
        <view class="modal-text">åœ¨è¿™ {{endedHabit.cycle_days || 21}} å¤©é‡Œï¼Œä½ åœ¨ {{endedHabit.completed_days || 0}} å¤©å®Œæˆäº†è¿™ä¸ªå¾®ä¹ æƒ¯ï¼Œå®Œæˆç‡ {{endedHabit.completion_rate || 0}}%ã€‚</view>
      </view>

      <view class="modal-buttons">
        <button class="btn btn-primary" bindtap="continueHabit">ç»§ç»­ä¸‹ä¸€è½® 21 å¤©</button>
        <button class="btn btn-secondary" bindtap="adjustHabit">å¤ªéš¾äº†ï¼Œæ”¹å°ä¸€ç‚¹</button>
        <button class="btn btn-ghost" bindtap="pauseHabit">å…ˆæš‚åœè¿™ä¸ªä¹ æƒ¯</button>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ‚¬æµ®æŒ‰é’® -->
  <view class="fab" bindtap="goToCreate">
    <text class="fab-text">+</text>
  </view>
</view>

