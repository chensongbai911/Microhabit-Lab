# 每日提醒功能部署指南

## 功能概述

每日提醒功能通过微信订阅消息实现,支持用户自定义提醒时间,在设定时间推送今日习惯完成情况。

## 一、前置条件

### 1. 小程序权限
确保小程序已开通以下权限:
- ✅ 订阅消息权限 (基础功能,所有小程序都有)
- ✅ 云开发能力

### 2. 订阅消息模板配建

登录微信公众平台,进行以下操作:

#### 步骤1: 进入订阅消息管理
1. 登录 [微信公众平台](https://mp.weixin.qq.com)
2. 点击左侧菜单「功能」-「订阅消息」
3. 点击「选用」按钮

#### 步骤2: 创建每日提醒模板

**模板1: 每日习惯提醒**
- 模板名称: 每日习惯提醒
- 场景: 习惯打卡提醒
- 内容示例:
  ```
  待办事项: 今日待完成: 3个习惯
  完成情况: 已完成: 1/3
  提醒时间: 2025-12-29 08:00
  温馨提示: 还有习惯未完成,加油!
  ```
- 跳转路径: pages/home/home

**推荐模板类型:**
- 类目: 生活服务 > 提醒服务
- 关键词: thing1(待办事项), thing2(完成情况), date3(提醒时间), thing4(温馨提示)

#### 步骤3: 获取模板ID
创建完成后,会生成一个模板ID,格式如: `aBcDeFgHiJkLmNoPqRsTuVwXyZ`

#### 步骤4: 更新代码中的模板ID

需要在以下文件中替换模板ID:

**1. settings.js (第31-35行)**
```javascript
const res = await wx.requestSubscribeMessage({
  tmplIds: [
    'YOUR_TEMPLATE_ID_DAILY',      // 替换为实际的模板ID
    'YOUR_TEMPLATE_ID_COMPLETION', // (可选)完成庆祝
    'YOUR_TEMPLATE_ID_MILESTONE'   // (可选)里程碑
  ]
});
```

**2. sendReminder/index.js (第103行)**
```javascript
await cloud.openapi.subscribeMessage.send({
  touser: openid,
  templateId: 'YOUR_TEMPLATE_ID_DAILY', // 替换为实际的模板ID
  page: 'pages/home/home',
  data: messageData,
  miniprogramState: 'formal'
});
```

## 二、云函数部署

### 1. 部署 updateUserSettings
```bash
# 进入云函数目录
cd cloudfunctions/updateUserSettings

# 安装依赖
npm install

# 上传并部署
# 在微信开发者工具中: 右键云函数目录 -> 上传并部署: 云端安装依赖
```

### 2. 部署 sendReminder
```bash
cd cloudfunctions/sendReminder
npm install
# 同样在开发者工具中上传并部署
```

### 3. 配置定时触发器

**重要说明**: 触发器配置有两个入口,请按以下步骤操作:

#### 方法1: 在微信开发者工具中配置 (推荐)

**步骤详解:**

1. **打开云开发控制台**
   - 在微信开发者工具顶部菜单栏,点击「云开发」按钮
   - 或者点击右上角的「云开发」图标

2. **进入云函数管理**
   - 在弹出的云开发控制台窗口中
   - 点击左侧导航栏的「云函数」
   - 你会看到所有已部署的云函数列表

3. **找到 sendReminder 函数**
   - 在云函数列表中找到 `sendReminder`
   - 点击函数名称进入详情页

4. **配置触发器**
   - 在函数详情页面,找到「触发器」标签页(如果没看到,可能需要向右滚动标签栏)
   - 如果你没有看到「触发器」选项卡,可能是因为:
     - 云开发环境版本较旧
     - 需要在网页版控制台配置

5. **添加触发器**
   - 点击「添加触发器」按钮
   - 填写以下信息:
     ```
     触发器名称: sendReminder_morning
     触发周期: 自定义触发周期
     Cron 表达式: 0 0 8 * * * *
     ```
   - 点击「确定」保存

6. **添加第二个触发器**
   - 重复步骤5,添加晚间触发器:
     ```
     触发器名称: sendReminder_evening
     Cron 表达式: 0 0 20 * * * *
     ```

#### 方法2: 在网页版云开发控制台配置 (如果开发者工具找不到)

**如果在开发者工具中找不到「触发器」选项,请使用此方法:**

1. **访问网页版控制台**
   - 打开浏览器,访问: https://console.cloud.tencent.com/tcb
   - 使用小程序管理员账号登录

2. **选择环境**
   - 在左侧选择你的云开发环境
   - 进入「云函数」管理页面

3. **配置触发器**
   - 点击 `sendReminder` 函数
   - 找到「触发器」选项卡
   - 点击「新建触发器」
   - 按照上述配置填写

#### 方法3: 使用云函数配置文件 (最简单)

**如果以上两种方法都不行,推荐使用配置文件方式:**

1. **创建配置文件**

   在 `cloudfunctions/sendReminder/` 目录下创建 `config.json` 文件:

```json
{
  "triggers": [
    {
      "name": "morning_reminder",
      "type": "timer",
      "config": "0 0 8 * * * *"
    },
    {
      "name": "evening_reminder",
      "type": "timer",
      "config": "0 0 20 * * * *"
    }
  ]
}
```

2. **重新部署云函数**
   - 右键 `sendReminder` 文件夹
   - 选择「上传并部署:云端安装依赖」
   - 部署时会自动创建触发器

3. **验证触发器**
   - 部署完成后,在云开发控制台查看
   - 应该能看到两个触发器已创建

#### 方法4: 临时测试方案 (跳过触发器)

**如果暂时无法配置触发器,可以先手动测试:**

1. **手动触发云函数**
   - 在云开发控制台,找到 `sendReminder` 函数
   - 点击「云端测试」
   - 输入 `{}` (空对象)
   - 点击「测试」按钮

2. **通过代码定时调用**

   可以暂时在小程序端定时调用(仅用于测试):
   ```javascript
   // 在 app.js 的 onShow 中添加
   onShow() {
     // 检查是否到提醒时间,手动触发
     const now = new Date();
     const hour = now.getHours();
     if (hour === 8 || hour === 20) {
       wx.cloud.callFunction({
         name: 'sendReminder',
         data: {}
       });
     }
   }
   ```

   **注意**: 此方法仅供测试,正式使用请配置定时触发器

**Cron表达式说明:**
```
格式: 秒 分 时 日 月 星期 年
0 0 8 * * * *  = 每天早上8:00:00
0 0 20 * * * * = 每天晚上20:00:00
0 */5 * * * * * = 每5分钟执行一次(测试用)
```

**验证触发器是否生效:**
```bash
1. 在云开发控制台查看触发器列表
2. 查看云函数的执行日志
3. 等待到设定时间,查看是否自动执行
4. 检查日志中的执行时间和返回结果
```

### 4. 配置云函数权限

在云开发控制台中,为 `sendReminder` 函数添加以下权限:
1. 数据库读写权限
2. 订阅消息发送权限 (云调用 API)

## 三、测试流程

### 1. 本地测试
```bash
# 在开发者工具中测试云函数
# 右键 sendReminder -> 云端测试
# 传入空对象 {} 即可
```

### 2. 功能测试步骤

**Step 1: 测试设置页面**
1. 启动小程序
2. 在首页点击右上角设置图标
3. 查看设置页面是否正常显示

**Step 2: 测试订阅授权**
1. 打开提醒开关
2. 查看是否弹出订阅消息授权弹窗
3. 点击「允许」
4. 检查订阅状态是否更新

**Step 3: 测试时间设置**
1. 点击早间提醒时间
2. 选择新时间
3. 检查是否保存成功
4. 重新进入页面,检查时间是否保持

**Step 4: 测试云函数**
```javascript
// 在云开发控制台测试 updateUserSettings
{
  "reminder_settings": {
    "enabled": true,
    "time1": "08:00",
    "time2": "20:00"
  }
}

// 测试 sendReminder (传空对象)
{}
```

**Step 5: 测试订阅消息发送**
1. 确保已授权订阅消息
2. 确保今日有未完成习惯
3. 手动触发 sendReminder 云函数
4. 在微信中查看是否收到服务通知

### 3. 常见问题排查

**问题1: 收不到订阅消息**
- [ ] 检查是否已授权订阅消息
- [ ] 检查模板ID是否正确
- [ ] 检查云函数日志是否有错误
- [ ] 检查用户是否有今日习惯
- [ ] 检查 `reminder_settings.enabled` 是否为 true

**问题2: 授权弹窗不显示**
- [ ] 检查模板ID格式是否正确
- [ ] 检查是否在开发者工具中测试(需真机测试)
- [ ] 检查小程序是否有订阅消息权限

**问题3: 定时触发器不执行**
- [ ] 检查触发器是否创建成功
- [ ] 检查 Cron 表达式是否正确
- [ ] 查看云函数日志
- [ ] 检查云函数是否有足够的执行次数配额

## 四、数据库字段说明

### users 集合新增字段
```javascript
{
  reminder_settings: {
    enabled: Boolean,        // 是否开启提醒
    time1: String,          // 早间提醒时间 "08:00"
    time2: String,          // 晚间提醒时间 "20:00"
  },
  last_subscribe_time: Date  // 最后订阅时间
}
```

## 五、上线前检查清单

- [ ] 在微信公众平台创建订阅消息模板
- [ ] 获取模板ID并更新到代码中
- [ ] 部署 updateUserSettings 云函数
- [ ] 部署 sendReminder 云函数
- [ ] 配置定时触发器(早8点、晚8点)
- [ ] 配置云函数权限(数据库、订阅消息)
- [ ] 真机测试订阅授权流程
- [ ] 真机测试手动触发云函数发送消息
- [ ] 验证定时触发器是否正常执行
- [ ] 测试多个用户同时接收消息
- [ ] 检查云函数执行日志
- [ ] 设置云函数监控告警

## 六、后续优化方向

### V1.1 智能提醒
- 根据触发器推荐最佳提醒时间
- 学习用户完成习惯的时间段

### V1.2 多样化提醒
- 完成庆祝消息(全部完成时)
- 周期里程碑提醒(7天、14天、21天)
- 连续打卡streak提醒

### V1.3 精细化控制
- 每个习惯独立设置提醒时间
- 自定义提醒文案
- 选择提醒习惯

### V1.4 再激活策略
- 48小时未打开自动提醒
- 连续3天未完成习惯提醒
- 周报总结推送

## 七、成本估算

### 云函数调用
- 每天2次定时触发(早8点、晚8点)
- 每次遍历所有开启提醒的用户
- 假设1000个活跃用户: 2次/天 × 30天 = 60次/月
- 云函数资源包: 免费额度足够

### 订阅消息
- 微信订阅消息: 完全免费
- 无发送数量限制
- 用户需主动授权(每次授权可发送一次)

### 优化建议
- 在用户每次打开小程序时,静默续订订阅消息
- 在打卡成功后,提示用户续订
- 设置合理的提醒频率,避免打扰

## 八、监控指标

建议监控以下指标:
- 订阅消息授权率
- 每日发送成功率
- 用户提醒设置开启率
- 收到提醒后的打开率
- 提醒后的完成率提升

## 相关文档
- [微信订阅消息官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/subscribe-message.html)
- [云函数定时触发器](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/functions/triggers.html)
- [云调用API](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/openapi/openapi.html)
